name: Deploy to GitHub Pages

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  deploy-to-github-pages:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      # PASO 1: DIAGN√ìSTICO DE PROYECTOS
      # Listamos todos los archivos .csproj para ver c√≥mo se llaman realmente
      - name: Listar Proyectos Disponibles
        run: |
          echo "üîç Buscando archivos .csproj en todo el repositorio:"
          find . -name "*.csproj"

      # PASO 2: PUBLICAR ESPEC√çFICAMENTE EL CLIENTE
      # Forzamos la b√∫squeda de algo que termine en 'Client.csproj'
      - name: Publish Client Project
        run: |
          # Buscamos el archivo
          CLIENT_PROJECT=$(find . -name "*Client.csproj" -type f | head -n 1)
          
          if [ -z "$CLIENT_PROJECT" ]; then
            echo "‚ùå ERROR FATAL: No encontr√© ning√∫n archivo que termine en 'Client.csproj'"
            exit 1
          fi
          
          echo "‚úÖ Compilando proyecto: $CLIENT_PROJECT"
          
          # Publicamos en la carpeta 'release'
          dotnet publish "$CLIENT_PROJECT" -c Release -o release --nologo

      # PASO 3: DIAGN√ìSTICO DE SALIDA (CRUCIAL)
      # Esto nos mostrar√° qu√© rayos se gener√≥ en la carpeta release
      - name: Ver contenido de carpeta release
        run: |
          echo "üìÇ Contenido de la carpeta 'release':"
          ls -R release

      # PASO 4: ENCONTRAR INDEX.HTML Y CORREGIRLO
      # Buscamos el archivo donde sea que haya ca√≠do
      - name: Fix base-tag and copy 404
        run: |
          # Buscamos index.html dentro de release (recursivo)
          INDEX_PATH=$(find release -name index.html -type f | head -n 1)

          if [ -z "$INDEX_PATH" ]; then
            echo "‚ùå ERROR: Sigue sin aparecer index.html. Revisa el paso 'Ver contenido de carpeta release' en los logs."
            exit 1
          fi

          echo "‚úÖ Encontr√© el index en: $INDEX_PATH"
          
          # Obtenemos la carpeta donde vive el index (usualmente release/wwwroot)
          WWWROOT_DIR=$(dirname "$INDEX_PATH")
          
          # 1. Cambiar base tag (Reemplaza ReportAnalizerWASM por tu repo si es diferente)
          sed -i 's/<base href="\/" \/>/<base href="\/ReportAnalizerWASM\/" \/>/g' "$INDEX_PATH"
          
          # 2. Crear copia 404
          cp "$INDEX_PATH" "$WWWROOT_DIR/404.html"
          
          # 3. Crear .nojekyll
          touch "$WWWROOT_DIR/.nojekyll"
          
          # Guardamos la ruta para el siguiente paso
          echo "DEPLOY_FOLDER=$WWWROOT_DIR" >> $GITHUB_ENV

      # PASO 5: SUBIR A GITHUB
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: ${{ env.DEPLOY_FOLDER }} # Usamos la carpeta que detectamos autom√°ticamente
