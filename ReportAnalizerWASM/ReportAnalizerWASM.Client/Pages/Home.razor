@page "/"
@using CsvHelper
@using System.Globalization
@using System.IO
@using ReportAnalizerWASM.Client.Models
@rendermode InteractiveWebAssembly

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    <MudText Typo="Typo.h3" GutterBottom="true">Dashboard MP</MudText>

    @if (!string.IsNullOrEmpty(mensajeError))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4">@mensajeError</MudAlert>
    }

    <MudPaper Class="pa-6 mb-6" Elevation="3">
        <MudText Typo="Typo.h6" Class="mb-4">1. Cargar Reporte</MudText>

        <MudFileUpload T="IBrowserFile" OnFilesChanged="ProcesarArchivo">
            <ActivatorContent>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           Disabled="@cargando"
                           StartIcon="@Icons.Material.Filled.CloudUpload">
                    @(cargando ? "Procesando..." : "Subir Reporte CSV")
                </MudButton>
            </ActivatorContent>
        </MudFileUpload>

        @if (cargando)
        {
            <div class="mt-3 d-flex align-center">
                <MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <MudText Typo="Typo.body2">Leyendo transacciones...</MudText>
            </div>
        }
    </MudPaper>

    @if (resumen != null)
    {
        <MudGrid>
            <MudItem xs="12" sm="4">
                <MudPaper Class="pa-4 border-l-4 border-solid mud-border-primary" Elevation="2">
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary">Ventas Brutas</MudText>
                    <MudText Typo="Typo.h4">@resumen.VentasTotales.ToString("C0", CultureInfo.GetCultureInfo("es-AR"))</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="4">
                <MudPaper Class="pa-4 border-l-4 border-solid mud-border-error" Elevation="2">
                    <MudText Typo="Typo.subtitle2" Color="Color.Error">Comisiones e Imp.</MudText>
                    <MudText Typo="Typo.h4">-@((resumen.ComisionesTotales + resumen.ImpuestosTotales).ToString("C0", CultureInfo.GetCultureInfo("es-AR")))</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="4">
                <MudPaper Class="pa-4 border-l-4 border-solid mud-border-success" Elevation="2">
                    <MudText Typo="Typo.subtitle2" Color="Color.Success">Neto en Mano</MudText>
                    <MudText Typo="Typo.h4">@resumen.NetoReal.ToString("C0", CultureInfo.GetCultureInfo("es-AR"))</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="8">
                <MudPaper Class="pa-6" Elevation="3">
                    <MudText Typo="Typo.h6" Class="mb-4">Evolución de Ingresos (Día a día)</MudText>
                    <MudChart ChartType="ChartType.Line"
                              ChartSeries="@seriesBarras"
                              XAxisLabels="@labelsDias"
                              Width="100%" Height="300px" />
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudPaper Class="pa-6" Elevation="3">
                    <MudText Typo="Typo.h6" Align="Align.Center" Class="mb-4">Distribución de Costos</MudText>
                    <MudChart ChartType="ChartType.Donut"
                              InputData="@graficoDonutData"
                              InputLabels="@graficoDonutLabels"
                              Width="100%" Height="300px" />
                </MudPaper>
            </MudItem>

            <MudItem xs="12">
                <MudAlert Severity="Severity.Info">
                    Se procesaron @ventasEncontradas movimientos de liberación de dinero.
                </MudAlert>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    private ResumenEstadistico resumen;
    private string mensajeError = "";
    private bool cargando = false;
    private int ventasEncontradas = 0;

    // Datos para gráficos
    private double[] graficoDonutData;
    private string[] graficoDonutLabels = { "Neto", "Comisiones", "Impuestos" };
    private List<ChartSeries> seriesBarras = new List<ChartSeries>();
    private string[] labelsDias;

    private async Task ProcesarArchivo(InputFileChangeEventArgs e)
    {
        mensajeError = "";
        cargando = true;
        resumen = null;

        // Limpiamos los gráficos para que no se queden con "basura" vieja
        seriesBarras = new List<ChartSeries>();
        labelsDias = new string[] { };

        StateHasChanged();
        await Task.Delay(100);

        try
        {
            var file = e.File;
            using var ms = new MemoryStream();
            using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            await stream.CopyToAsync(ms);
            ms.Position = 0;

            using var reader = new StreamReader(ms);
            var config = new CsvHelper.Configuration.CsvConfiguration(CultureInfo.InvariantCulture)
            {
                Delimiter = ";",
                PrepareHeaderForMatch = args => args.Header.ToUpper(),
                HeaderValidated = null,
                MissingFieldFound = null,
            };

            using var csv = new CsvReader(reader, config);
            var registros = csv.GetRecords<TransaccionMP>().ToList();

            var nuevoResumen = new ResumenEstadistico();
            ventasEncontradas = 0;

            var ventas = registros
                .Where(x => !string.IsNullOrEmpty(x.DESCRIPTION) && x.DESCRIPTION.Contains("payment"))
                .ToList();

            foreach (var item in ventas)
            {
                ventasEncontradas++;
                nuevoResumen.VentasTotales += item.GROSS_AMOUNT;
                nuevoResumen.ComisionesTotales += Math.Abs(item.MP_FEE_AMOUNT);
                nuevoResumen.ImpuestosTotales += Math.Abs(item.TAXES_AMOUNT);
            }

            resumen = nuevoResumen;

            // --- GRÁFICO DONUT ---
            graficoDonutData = new double[] {
                (double)resumen.NetoReal,
                (double)resumen.ComisionesTotales,
                (double)resumen.ImpuestosTotales
            };

            // --- GRÁFICO BARRAS (SOLUCIÓN DEFINITIVA) ---
            var ventasPorDia = ventas
                .GroupBy(x => DateTime.Parse(x.DATE).Date)
                .OrderBy(g => g.Key)
                .Select(g => new { Fecha = g.Key, Total = g.Sum(x => x.GROSS_AMOUNT) })
                .ToList();

            // 1. Cargamos los datos de las barras (el alto de la barra)
            seriesBarras = new List<ChartSeries>()
            {
                new ChartSeries() { Name = "Ingresos", Data = ventasPorDia.Select(x => (double)x.Total).ToArray() }
            };

            // 2. AQUÍ ESTÁ EL TRUCO PARA QUE NO SE ENCIMEN LOS TEXTOS
            // Usamos una lista temporal para construir las etiquetas
            var etiquetasTemp = new List<string>();

            for (int i = 0; i < ventasPorDia.Count; i++)
            {
                // Si es el primero, el último, o cada 5 días... mostramos la fecha
                if (i == 0 || i == ventasPorDia.Count - 1 || i % 4 == 0)
                {
                    etiquetasTemp.Add(ventasPorDia[i].Fecha.ToString("dd/MM"));
                }
                else
                {
                    // Si no, agregamos un espacio vacío (INVISIBLE)
                    etiquetasTemp.Add(" ");
                }
            }

            // Convertimos la lista a Array para que MudBlazor la entienda
            labelsDias = etiquetasTemp.ToArray();

            if (ventasEncontradas == 0) mensajeError = "No se encontraron ventas.";
        }
        catch (Exception ex)
        {
            mensajeError = $"Error: {ex.Message}";
        }
        finally
        {
            cargando = false;
            StateHasChanged();
        }
    }

    public class ResumenEstadistico
    {
        public decimal VentasTotales { get; set; }
        public decimal ComisionesTotales { get; set; }
        public decimal ImpuestosTotales { get; set; }
        public decimal NetoReal => VentasTotales - ComisionesTotales - ImpuestosTotales;
    }
}