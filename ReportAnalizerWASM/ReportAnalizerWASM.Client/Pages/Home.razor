@page "/"
@using ReportAnalizerWASM.Client.Models

<PageTitle>MP Analyzer - Evolución</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" Color="Color.Primary" GutterBottom="true">Tablero de Control</MudText>
    
    <MudPaper Class="pa-4 mb-4" Elevation="3">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudFileUpload T="IBrowserFile" Accept=".xlsx" FilesChanged="CargarExcel">
                <ActivatorContent>
                    <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.TableView">
                        Cargar Excel Ventas
                    </MudButton>
                </ActivatorContent>
            </MudFileUpload>

            @if (_ventasTodas.Any())
            {
                <MudDateRangePicker Label="Filtrar Período"
                                    DateRange="_rangoFechas"
                                    DateRangeChanged="OnRangoCambiado"
                                    Placeholder="Selecciona rango"
                                    Color="Color.Primary"
                                    Class="w-25" />
            }
        </MudStack>
        
        @if (_cargando)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mt-2" />
            <MudText Typo="Typo.caption">Procesando fechas e inteligencia temporal...</MudText>
        }
    </MudPaper>

    @if (_error != null)
    {
        <MudAlert Severity="Severity.Error" Class="mb-4">@_error</MudAlert>
    }

    @if (_ventasFiltradas.Any())
    {
        <MudPaper Class="pa-4 mb-4">
            <MudText Typo="Typo.h6">Evolución de Ventas (Diaria)</MudText>
                <MudChart ChartType="ChartType.Line"
                          XAxisLabels="@_labelsEvolucion"
                          ChartSeries="@_seriesEvolucion"
                          Width="100%" Height="350px" />
        </MudPaper>

        <MudGrid Class="mb-4">
            <MudItem xs="12" sm="3">
                <MudPaper Class="pa-4 mud-theme-primary">
                    <MudText>Ventas Brutas</MudText>
                    <MudText Typo="Typo.h5">@_ventasFiltradas.Sum(x => x.MontoBruto).ToString("C0", _cultureArg)</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudPaper Class="pa-4" Style="background-color:#d32f2f; color:white;">
                    <MudText>Retenciones (Fuga)</MudText>
                    <MudText Typo="Typo.h5">@_ventasFiltradas.Sum(x => x.MontoImpuestos).ToString("C0", _cultureArg)</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudPaper Class="pa-4 mud-theme-success">
                    <MudText>Ganancia Neta</MudText>
                    <MudText Typo="Typo.h5">@_ventasFiltradas.Sum(x => x.MontoNeto).ToString("C0", _cultureArg)</MudText>
                </MudPaper>
            </MudItem>
             <MudItem xs="12" sm="3">
                <MudPaper Class="pa-4">
                    <MudText>Ticket Promedio</MudText>
                    <MudText Typo="Typo.h5">@((_ventasFiltradas.Sum(x => x.MontoBruto) / _ventasFiltradas.Count).ToString("C0", _cultureArg))</MudText>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <MudDataGrid Items="@_ventasFiltradas" Filterable="true" SortMode="SortMode.Multiple" Elevation="2">
            <Columns>
                <PropertyColumn Property="x => x.Fecha" Title="Fecha" Format="dd/MM/yyyy HH:mm" />
                <PropertyColumn Property="x => x.Producto" Title="Producto" />
                <PropertyColumn Property="x => x.MontoBruto" Title="Bruto" Format="C0" Culture="@_cultureArg" />
                <PropertyColumn Property="x => x.MontoImpuestos" Title="Impuestos" Format="C0" Culture="@_cultureArg">
                    <CellTemplate>
                        @if (context.Item.MontoImpuestos < 0)
                        {
                            <span style="color: #d32f2f; font-weight:bold;">@context.Item.MontoImpuestos.ToString("C2", _cultureArg)</span>
                        }
                        else { <span>-</span> }
                    </CellTemplate>
                </PropertyColumn>
                <PropertyColumn Property="x => x.MontoNeto" Title="Neto" Format="C0" Culture="@_cultureArg" CellStyle="font-weight:bold;" />
            </Columns>
            <PagerContent>
                <MudDataGridPager T="VentaItem" />
            </PagerContent>
        </MudDataGrid>
    }
</MudContainer>
